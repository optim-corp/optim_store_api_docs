<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>SCIM Client Setup</title>

  <meta name="author" content="OPTiM Inc." />

  
  <meta name="description" content="OPTiM Store API Docs">
  

  
    
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
    
  

  
    
      <link rel="stylesheet" href="/optim_store_api_docs/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/optim_store_api_docs/css/main.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

  <!-- Facebook OpenGraph tags -->
  <meta property="og:title" content="SCIM Client Setup" />
  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="/optim_store_api_docs//setup/scim" />
  

  
  <meta property="og:image" content="/optim_store_api_docs//img/avatar-icon.png" />
  

</head>


  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/optim_store_api_docs/">OPTiM Store API Docs</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            

<a href="/optim_store_api_docs/">Back to TOP</a>

          </li>
        
        
      </ul>
    </div>

  
  <div class="avatar-container">
    <div class="avatar-img-border">
      <a href="/optim_store_api_docs/ ">
        <img class="avatar-img" src="/optim_store_api_docs/img/avatar-icon.png" />
    </a>
    </div>
  </div>
  

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-heading">
          <h1>SCIM Client Setup</h1>
      
        
            <hr class="small">
            <span class="page-subheading">OPTiM Store API Docs</span>
      
      
      
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <p>SCIM Protocol に従い Provisioning をするために、SCIM Server となる御社サービスに対して OPTiM Store から SCIM Client を登録するための API です。</p>

<p><a href="https://tools.ietf.org/html/rfc7591">OAuth 2.0 Dynamic Client Registration Protocol</a> に準拠した形で SCIM 用 OAuth Client を登録します。</p>

<p><strong>御社サービス側に SCIM Client Registration API Endpoint をご用意いただく必要があります</strong>。当該 Endpoint URL は、OPTiM Store へのアプリ登録時に設定します。</p>

<h2 id="section">事前設定項目</h2>

<p>以降、本ドキュメントでは、OPTiM Store の URL を以下の値と仮定して説明を進めます。</p>

<ul>
  <li>https://optim-store.optim.co.jp</li>
</ul>

<p>御社サービスを OPTiM Store に登録する際に、御社サービス側の以下の API Endpoint URLs を OPTiM Store に登録していただきます。</p>

<ul>
  <li><strong>SCIM Client Registration API Endpoint</strong></li>
  <li><strong>OAuth 2.0 Token Endpoint</strong></li>
  <li><strong>SCIM API Endpoint</strong></li>
</ul>

<p>以降、本ドキュメントでは、御社サービス側の SCIM Client Registration API Endpoint を以下の値と仮定して説明を進めます。</p>

<ul>
  <li>https://your-service.example.com/scim/clients</li>
</ul>

<p>また <a href="/optim_store_api_docs/setup/contract">Tenant Contract Setup</a> のテナント契約開始リクエストに含まれていた <strong>contract_jwk</strong> (OPTiM 側の当該テナント契約に紐づく RSA 公開鍵) によってリクエスト署名を検証する必要があるので、事前にテナント契約が成立している必要があります。</p>

<h2 id="scim-client-registration-request">SCIM Client Registration Request</h2>

<p>テナント契約が成立した後に、OPTiM Store から御社サービスの SCIM Client Registration API Endpoint に以下のような JSON データを送ります。(実際には以下の JSON に JWS 仕様にしたがって署名したデータが送られます)</p>

<p>現状ではこのリクエスト内容は Timestamp 値をのぞいては固定値です。</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://optim-store.optim.co.jp"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://your-service.example.com/scim/clients"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1464053706</span><span class="p">,</span><span class="w">
  </span><span class="nt">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1464054306</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h3 id="json">リクエストJSONの各要素について</h3>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>iss</strong></td>
      <td>リクエスト発行者 (issuer) の識別子です。OPTiM Store の URL となります。</td>
    </tr>
    <tr>
      <td><strong>aud</strong></td>
      <td>リクエスト受信者 (audience) の識別子です。御社サービスの <strong>SCIM Client Registration API Endpoint URL</strong> となります。</td>
    </tr>
    <tr>
      <td><strong>iat</strong></td>
      <td>リクエスト生成日時 (issued_at) を示す Unix Timestamp です。</td>
    </tr>
    <tr>
      <td><strong>exp</strong></td>
      <td>リクエストの有効期限 (expires_at) を示す Unix Timestamp です。</td>
    </tr>
  </tbody>
</table>

<p>注) 各要素の意味は <a href="/optim_store_api_docs/setup/contract">Tenant Contract Setup</a> のテナント契約開始リクエストとほぼ同じですが、<strong>aud</strong> の値はテナント開始リクエスト時とは異なります。(<strong>Tenant Contract API Endpoint URL</strong> ではなく <strong>SCIM Client Registration API Endpoint URL</strong>)</p>

<h3 id="section-1">署名付きリクエスト</h3>

<p>実際の POST Body は、上記の JSON に OPTiM Store 側の当該テナント契約に紐付いた RSA 秘密鍵で署名したものを <strong>software_statement</strong> という key に wrap した JSON データになります。</p>

<p>署名に使用された鍵の ID (kid) は、JWS Header の <strong>kid</strong> に指定されていますので、御社サービス側ではその <strong>kid</strong> をもとに対応するテナント契約を特定してください。</p>

<p><strong>JWS Header 例</strong></p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"u67PW3Rc0To3t_4fPz3Cwb0fuxICXXhI8SwBnak4C6Q"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p><strong>JWS Payload 例</strong></p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://optim-store.optim.co.jp"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://your-service.example.com/scim/clients"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1464053706</span><span class="p">,</span><span class="w">
  </span><span class="nt">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1464054306</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p><strong>署名付き JSON 例</strong></p>

<pre><code class="language-jws">eyJhbGciOiJSUzI1NiIsImtpZCI6InU2N1BXM1JjMFRvM3RfNGZQejNDd2IwZnV4SUNYWGhJOFN3Qm5hazRDNlEifQ.eyJ0b2tlbl9lbmRwb2ludF9hdXRoX21ldGhvZCI6ImNsaWVudF9zZWNyZXRfYmFzaWMiLCJncmFudF90eXBlcyI6ImNsaWVudF9jcmVkZW50aWFscyIsImNsaWVudF9uYW1lIjoiT3B0aW0gU3RvcmUgQ29udHJhY3QjMTIzNDUifQ.aBu83V3iJrYpH6yZdBdEfERvJxCAdOKtHaIiELLCWVaY9iqNP8yiAfm2sXePG1WaPm2K_RPBc_03s-vJSwDr_opgt8Va5pSLLW90JQ-hLXZIav0yu2NF3ZWCOP0ku5hzpOopOHP2gLXMAA1Bt1FcqQTwH6TBgPWIe1zbvtQe4UgxQncmyllvlvmvGygmrPaUGS0GNMr_kbkP1yccwlb3C30Kea5Ljsc-Y4nsFCw81r90Dm-hoe3Ox8Jrjq9P5KC7Z_Cqj5CGmff3pCQIT3gjU677cSgJr7F-W0Xi15970Xlv_z4rUmNqTKQHOQgkCMj7VxTRO03ajf7KqjtmB8VkJw
</code></pre>

<p><strong>Request Body 例</strong></p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"software_statement"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eyJhbGciOiJSUzI1NiIsImtpZCI6InU2N1BXM1JjMFRvM3RfNGZQejNDd2IwZnV4SUNYWGhJOFN3Qm5hazRDNlEifQ.eyJ0b2tlbl9lbmRwb2ludF9hdXRoX21ldGhvZCI6ImNsaWVudF9zZWNyZXRfYmFzaWMiLCJncmFudF90eXBlcyI6ImNsaWVudF9jcmVkZW50aWFscyIsImNsaWVudF9uYW1lIjoiT3B0aW0gU3RvcmUgQ29udHJhY3QjMTIzNDUifQ.aBu83V3iJrYpH6yZdBdEfERvJxCAdOKtHaIiELLCWVaY9iqNP8yiAfm2sXePG1WaPm2K_RPBc_03s-vJSwDr_opgt8Va5pSLLW90JQ-hLXZIav0yu2NF3ZWCOP0ku5hzpOopOHP2gLXMAA1Bt1FcqQTwH6TBgPWIe1zbvtQe4UgxQncmyllvlvmvGygmrPaUGS0GNMr_kbkP1yccwlb3C30Kea5Ljsc-Y4nsFCw81r90Dm-hoe3Ox8Jrjq9P5KC7Z_Cqj5CGmff3pCQIT3gjU677cSgJr7F-W0Xi15970Xlv_z4rUmNqTKQHOQgkCMj7VxTRO03ajf7KqjtmB8VkJw"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>OPTiM Store では、テナント契約成立直後に上記 JSON データを御社サービスの SCIM Client Registration API Endpoint に HTTP POST で送信します。</p>

<h3 id="section-2">リクエスト署名の検証</h3>

<p>以下では Ruby の json-jwt gem を利用して、上記署名付き JSON リクエストの署名検証を行っています。</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'json/jwt'</span>

<span class="n">software_statement</span> <span class="o">=</span> <span class="s2">"eyJhbGciOiJSUzI1NiIsImtpZCI6InU2N1BXM1JjMFRvM3RfNGZQejNDd2IwZnV4SUNYWGhJOFN3Qm5hazRDNlEifQ.eyJ0b2tlbl9lbmRwb2ludF9hdXRoX21ldGhvZCI6ImNsaWVudF9zZWNyZXRfYmFzaWMiLCJncmFudF90eXBlcyI6ImNsaWVudF9jcmVkZW50aWFscyIsImNsaWVudF9uYW1lIjoiT3B0aW0gU3RvcmUgQ29udHJhY3QjMTIzNDUifQ.aBu83V3iJrYpH6yZdBdEfERvJxCAdOKtHaIiELLCWVaY9iqNP8yiAfm2sXePG1WaPm2K_RPBc_03s-vJSwDr_opgt8Va5pSLLW90JQ-hLXZIav0yu2NF3ZWCOP0ku5hzpOopOHP2gLXMAA1Bt1FcqQTwH6TBgPWIe1zbvtQe4UgxQncmyllvlvmvGygmrPaUGS0GNMr_kbkP1yccwlb3C30Kea5Ljsc-Y4nsFCw81r90Dm-hoe3Ox8Jrjq9P5KC7Z_Cqj5CGmff3pCQIT3gjU677cSgJr7F-W0Xi15970Xlv_z4rUmNqTKQHOQgkCMj7VxTRO03ajf7KqjtmB8VkJw"</span>

<span class="c1"># NOTE: "kid" を取得</span>
<span class="n">unverified_jwt</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">::</span><span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">software_statement</span><span class="p">,</span> <span class="ss">:skip_verification</span><span class="p">)</span>
<span class="n">kid</span> <span class="o">=</span> <span class="n">unverified_jwt</span><span class="p">.</span><span class="nf">header</span><span class="p">[</span><span class="ss">:kid</span><span class="p">]</span>

<span class="c1"># NOTE: Contract Start API で OPTiM Store から受け取った契約毎の公開鍵 (実際には上記 "kid" をもとに DB などから取得)</span>
<span class="n">contract_public_jwk</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"kid"</span><span class="p">:</span> <span class="s2">"u67PW3Rc0To3t_4fPz3Cwb0fuxICXXhI8SwBnak4C6Q"</span><span class="p">,</span>
  <span class="s2">"kty"</span><span class="p">:</span> <span class="s2">"RSA"</span><span class="p">,</span>
  <span class="s2">"e"</span><span class="p">:</span> <span class="s2">"AQAB"</span><span class="p">,</span>
  <span class="s2">"n"</span><span class="p">:</span> <span class="s2">"yUB7KMp_ZsEbK734sMPjRSPfM7pV0Jf5KyjkkXk5Mw6Jja8z-ZTigqaoJVcV4tFX2CyTqDmVNgzb9oQJL62otjDWRwdFL99Rdor_YsxZt2eOSnBBY8PdhjYHTJtczIXsCHtYtx0clYcjMjvwNG_FIL4UJILmiHPxMMmWxPjEtTIo0pp8KdrrGZExJp4UD7JC7nPiNdvs31GHV0IoXpxqQAatfFBwQHFG3Fxsz7JS9p3mf_VBZ2CyPsdS58NqMPQVBbyxsdbK_OiPOk-4dmlJtxZFTMjXoBg4-hL9B1rRrUrN5ttm7QjJr3wjnKUy_OdKsqjxhPaj7XV04TuxBhxzOw"</span>
<span class="p">}</span>
<span class="n">contract_public_key</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">::</span><span class="no">JWK</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">contract_public_jwk</span><span class="p">)</span>

<span class="c1"># NOTE: 署名検証</span>
<span class="n">verified_request</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">::</span><span class="no">JWT</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">software_statement</span><span class="p">,</span> <span class="n">contract_public_jwk</span><span class="p">)</span>
</code></pre>
</div>

<p>その他の JWT/JWS ライブラリを利用する場合は、各ライブラリのドキュメントを参照してください。</p>

<h2 id="scim-client-registration-response">SCIM Client Registration Response</h2>

<p>リクエスト検証成功後、御社サービス側で当該テナントに紐づく SCIM Client (OAuth Client) を登録し、以下のような JSON Response を返してください。</p>

<p>ここで発行された client_id &amp; client_secret は、後に Provisioning する際に access_token 発行目的で利用されます。</p>

<p>各パラメータは 255 byte 以下の JSON String としてください。</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"client_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a05d189799f16cd00088d8866283ee7e"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"client_secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"80fbd7da6000230b4575244ae8f854d6efe10eef46c68ba47806adc2df5a34cc"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

      
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/optim-corp" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
      
      
      
      
      
        </ul>
        <p class="copyright text-muted">
      OPTiM Inc.
      &nbsp;&bull;&nbsp;
      2016

      
      &nbsp;&bull;&nbsp;
      <a href="/optim_store_api_docs/"></a>
      
      </p>
          <!-- Please don't remove this, keep my open source work credited :) -->
    <p class="theme-by text-muted">
      Theme by
      <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    </p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
        if (typeof jQuery == 'undefined') {
          document.write('<script src="/optim_store_api_docs/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
        }
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
  <script src="/optim_store_api_docs/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
  <script src="/optim_store_api_docs/js/main.js"></script>
    
  





  
  </body>
</html>
